{"ts":1360870106622,"silentsave":true,"restoring":false,"patch":[[]],"length":0}
{"contributors":[],"silentsave":false,"ts":1360870153066,"patch":[[{"diffs":[[1,"var port = process.env.PORT || 4000,\r\n    app = require('./app').init(port),\r\n    dirty = require('dirty');\r\n\t\r\nvar locals = {\r\n\tauthor:'in1'\r\n\t// add other vars here\r\n};\r\n\r\nvar userDb = dirty('user.db');\r\n\r\napp.get('*', function(req,res,next){\r\n\tif (req.session) {\r\n\t\tlocals.session=req.session;\r\n\t\tlocals.once=\"\";\r\n\t}\r\n\t\r\n\tnext();\r\n});\r\n\r\napp.get('/', function(req,res){\r\n\tconsole.log(\"show home page\");\r\n\r\n    locals.date = new Date().toLocaleDateString();\r\n\t\r\n\tvar appDb = dirty('app.db'),\r\n\t\tsectionsDb;\r\n\t\r\n\tappDb.on('load', function() {\r\n\t\tsectionsDb = dirty('sections.db');\r\n\t\tsectionsDb.on('load', function() {\r\n\t\t\t/*\r\n\t\t\tsectionsDb.forEach(function(key, val) {\r\n\t\t\t\tconsole.log('Found key: %s, val: %j', key, val);\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\t\r\n\t\t\tif (typeof req.session.once==\"undefined\") {\r\n\t\t\t\tlocals.once=appDb.get('page').once;\r\n\t\t\t\treq.session.once=1;\r\n\t\t\t}\r\n\t\r\n\t\t\tres.render('index.ejs', {locals:locals,sections:sectionsDb,app:appDb.get('app'),page:appDb.get('page'),msg:req.query.msg,err:req.query.err});\r\n\t\t});\r\n\t});\r\n});\r\n\r\napp.get('/login', function(req,res){\r\n\tconsole.log(\"show login page\");\r\n\r\n\tvar appDb = dirty('app.db'),\r\n\t\tsectionsDb;\r\n\t\t\r\n\tappDb.on('load', function() {\r\n\t\tsectionsDb = dirty('sections.db');\r\n\t\tsectionsDb.on('load', function() {\r\n\t\t\tres.render('login', {locals:locals,sections:sectionsDb,app:appDb.get('app'),page:appDb.get('page'),err:req.query[\"err\"]});\r\n\t\t});\r\n\t});\r\n});\r\n\r\napp.post('/login', function(req,res){\r\n\tconsole.log(\"logging in\");\r\n\t\t\r\n\tvar userDb = dirty('user.db'),\r\n\t\tusername = req.body[\"username\"],\r\n\t\tpassword = req.body[\"password\"];\r\n\t\t\r\n\tif (typeof username==\"undefined\" || typeof password==\"undefined\") {\r\n\t\t//res.render('error', {msg:'You need to enter a username and password.'});\r\n\t\tres.redirect('/login?err=You need to enter a username and password.');\r\n\t}\r\n\telse {\r\n\t\tuserDb.on('load', function() {\r\n\t\t\tuser = userDb.get(username);\r\n\t\t\tif (typeof user==\"undefined\" || user.password!=password) {\r\n\t\t\t\tres.redirect('/login?err=User not found or wrong password.');\r\n\t\t\t}\r\n\t\t\telse if (!user.admin && user.admin!=1) {\r\n\t\t\t\tres.redirect('/login?err=You do not have permission to access this page.');\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\t/* set session login here*/\r\n\t\t\t\treq.session.loggedIn=true;\r\n\t\t\t\treq.session.username=username;\r\n\t\t\t\tres.redirect('/admin');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n});\r\n\r\napp.get('/logout', function(req,res){\r\n\tconsole.log(\"logging out\");\r\n\t\r\n\tdelete req.session.loggedIn;\r\n\tres.redirect('/');\r\n});\r\n\r\napp.get('/admin', function(req,res){\r\n\tconsole.log(\"getting admin page..\");\r\n\r\n    locals.date = new Date().toLocaleDateString();\r\n\t\t\r\n\tif (req.session.loggedIn) {\r\n\t\tvar appDb = dirty('app.db');\r\n\t\tappDb.on('load', function() {\r\n\t\t\tsectionsDb = dirty('sections.db');\r\n\t\t\tsectionsDb.on('load', function() {\r\n\t\t\t\t/*\r\n\t\t\t\tsectionsDb.forEach(function(key, val) {\r\n\t\t\t\t\tconsole.log('Found key: %s, val: %j', key, val);\r\n\t\t\t\t});\r\n\t\t\t\t*/\r\n\t\t\t\tsnippetsDb = dirty('snippet.db');\r\n\t\t\t\tsnippetsDb.on('load', function() {\r\n\t\t\t\t\tres.render('admin', {locals:locals,sections:sectionsDb,snippets:snippetsDb,app:appDb.get('app'),page:appDb.get('page'),msg:req.query.msg,err:req.query.err});\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t\t\r\n\t}\r\n\telse {\r\n\t\tres.redirect('/login');\r\n\t}\r\n});\r\n\r\napp.post('/contact', function(req,res){\r\n\tconsole.log('contact form submit..');\r\n\t\r\n\tappDb = dirty('app.db');\r\n\tpostDb = dirty('post.db');\r\n\t\r\n\tvar email = req.body[\"email\"],\r\n\t\tname = req.body[\"name\"],\r\n\t\tnotes = req.body[\"notes\"];\r\n\t\ttimestamp = new Date().getTime();\r\n\t\r\n\tif (email=='' && name=='' && notes=='') {\r\n\t\tres.send({err:\"The form is empty. Please fill it out before sending.\"});\r\n\t}\r\n\telse if (email=='' || typeof email==\"undefined\") {\r\n\t\tres.send({err:\"Please let us know your email so that we can contact you.\"});\r\n\t}\r\n\telse {\r\n\t\tif (validateEmail(email)){\r\n\t\t\tappDb.on('load', function() {\r\n\t\t\t\tvar key = timestamp,\r\n\t\t\t\t\tval = req.body;\r\n\t\t\t\t\tval.username = req.session.username; //append current user if avail\r\n\t\t\t\t\tval.ip = req.connection.remoteAddress;\r\n\r\n\t\t\t\tif (typeof key!=\"undefined\") {\r\n\t\t\t\t\tpostDb.set(key,val, function() {\r\n\t\t\t\t\t\t//console.log('Post saved', postDb.get(key));\r\n\t\t\t\t\t\tres.send({msg:'Thanks, we got it.'});\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tres.send({err:\"No key error.\"});\r\n\t\t\t\t}\r\n\t\t\t});\t\r\n\t\t}\r\n\t\telse {\r\n\t\t\tres.send({err:\"That email doesn't seem to be valid.\"});\r\n\t\t}\r\n\t}\r\n});\r\n\r\n/* The 404 Route (ALWAYS Keep this as the last route) */\r\napp.get('/*', function(req, res){\r\n    res.render('404.ejs', locals);\r\n});\r\n\r\n\r\n/* utils */\r\nfunction validateEmail (value) {\r\n  var isValid = /^((([a-z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+(\\.([a-z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+)*)|((\\x22)((((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(([\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x7f]|\\x21|[\\x23-\\x5b]|[\\x5d-\\x7e]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(\\\\([\\x01-\\x09\\x0b\\x0c\\x0d-\\x7f]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]))))*(((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(\\x22)))@((([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.)+(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.?$/i.test(value);\r\n  return isValid;\r\n}\r\n\r\n"]],"start1":0,"start2":0,"length1":0,"length2":5489}]],"length":5489,"saved":false}
{"contributors":[],"silentsave":false,"ts":1360870424544,"patch":[[{"diffs":[[0,"\r\n\t\t"],[-1,"var appDb = dirty('app.db');\r\n\t\tappDb.on('load', function() {\r\n\t\t\tsectionsDb = dirty('sections.db');\r\n\t\t\tsectionsDb.on('load', function() {\r\n\t\t\t\t/*\r\n\t\t\t\tsectionsDb.forEach(function(key, val) {\r\n\t\t\t\t\tconsole.log('Found key: %s, val: %j', key, val);\r\n\t\t\t\t});\r\n\t\t\t\t*/\r\n\t\t\t\tsnippetsDb = dirty('snippet.db');\r\n\t\t\t\tsnippetsDb.on('load', function() {\r\n\t\t\t\t\tres.render('admin', {locals:locals,sections:sectionsDb,snippets:snippetsDb,app:appDb.get('app'),page:appDb.get('page'),msg:req.query.msg,err:req.query.err});\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t\t"],[1," res.render('admin', {locals:locals);"],[0,"\r\n\t}"]],"start1":2624,"start2":2624,"length1":543,"length2":45}]],"length":4991,"saved":false}
{"ts":1360870433457,"patch":[[{"diffs":[[0,"ocals:locals"],[1,"}"],[0,");\r\n\t}\r\n\tels"]],"start1":2651,"start2":2651,"length1":24,"length2":25}]],"length":4992,"saved":false}
{"ts":1360870496086,"patch":[[{"diffs":[[0,"\r\n\r\n"],[-1,"app.post('/contact', function(req,res){\r\n\tconsole.log('contact form submit..');\r\n\t\r\n\tappDb = dirty('app.db');\r\n\tpostDb = dirty('post.db');\r\n\t\r\n\tvar email = req.body[\"email\"],\r\n\t\tname = req.body[\"name\"],\r\n\t\tnotes = req.body[\"notes\"];\r\n\t\ttimestamp = new Date().getTime();\r\n\t\r\n\tif (email=='' && name=='' && notes=='') {\r\n\t\tres.send({err:\"The form is empty. Please fill it out before sending.\"});\r\n\t}\r\n\telse if (email=='' || typeof email==\"undefined\") {\r\n\t\tres.send({err:\"Please let us know your email so that we can contact you.\"});\r\n\t}\r\n\telse {\r\n\t\tif (validateEmail(email)){\r\n\t\t\tappDb.on('load', function() {\r\n\t\t\t\tvar key = timestamp,\r\n\t\t\t\t\tval = req.body;\r\n\t\t\t\t\tval.username = req.session.username; //append current user if avail\r\n\t\t\t\t\tval.ip = req.connection.remoteAddress;\r\n\r\n\t\t\t\tif (typeof key!=\"undefined\") {\r\n\t\t\t\t\tpostDb.set(key,val, function() {\r\n\t\t\t\t\t\t//console.log('Post saved', postDb.get(key));\r\n\t\t\t\t\t\tres.send({msg:'Thanks, we got it.'});\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tres.send({err:\"No key error.\"});\r\n\t\t\t\t}\r\n\t\t\t});\t\r\n\t\t}\r\n\t\telse {\r\n\t\t\tres.send({err:\"That email doesn't seem to be valid.\"});\r\n\t\t}\r\n\t}\r\n});\r\n\r\n"],[0,"/* T"]],"start1":2715,"start2":2715,"length1":1133,"length2":8}]],"length":3867,"saved":false}
{"ts":1360870508429,"patch":[[{"diffs":[[0," {\r\n"],[-1,"\t\t//res.render('error', {msg:'You need to enter a username and password.'});\r\n"],[0,"\t\tre"]],"start1":1661,"start2":1661,"length1":86,"length2":8}]],"length":3789,"saved":false}
{"ts":1360870533442,"patch":[[{"diffs":[[0,"\t\r\n\t"],[-1,"var appDb = dirty('app.db'),\r\n\t\tsectionsDb;\r\n\t\r\n\tappDb.on('load', function() {\r\n\t\tsectionsDb = dirty('sections.db');\r\n\t\tsectionsDb.on('load', function() {\r\n\t\t\t/*\r\n\t\t\tsectionsDb.forEach(function(key, val) {\r\n\t\t\t\tconsole.log('Found key: %s, val: %j', key, val);\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\t\r\n\t\t\tif (typeof req.session.once==\"undefined\") {\r\n\t\t\t\tlocals.once=appDb.get('page').once;\r\n\t\t\t\treq.session.once=1;\r\n\t\t\t}\r\n\t\r\n\t\t\tres.render('index.ejs', {locals:locals,sections:sectionsDb,app:appDb.get('app'),page:appDb.get('page'),msg:req.query.msg,err:req.query.err});\r\n\t\t});\r\n\t"],[1,"res.render('index.ejs', {locals:locals"],[0,"});\r"]],"start1":461,"start2":461,"length1":566,"length2":46}]],"length":3269,"saved":false}
{"ts":1360871104603,"patch":[[{"diffs":[[0,"t('/');\r\n});\r\n\r\n"],[1,"\r\napp.get('/img', function(req,res){\r\n    console.log(\"logging out\");\r\n\t\r\n\tdelete req.session.loggedIn;\r\n\tres.redirect('/');\r\n});\r\n\r\n\r\n"],[0,"app.get('/admin'"]],"start1":1847,"start2":1847,"length1":32,"length2":167}]],"length":3404,"saved":false}
{"ts":1360871341159,"patch":[[{"diffs":[[0,"\n\t\r\n"],[-1,"\tdelete req.session.loggedIn;"],[1,"    createImage (request, response, function (data, request, response) {\r\n        if (data) {\r\n            //see if we have a callback function\r\n            if (request.session && request.session.callback) {\r\n                request.session.callback(data, request.session.oauth, request, response); \r\n            } else {\r\n                response.writeHead(200, {'Content-Type' : 'image/png', 'Content-Size' : data.length }); \r\n                response.write(data);\r\n                response.end ();\r\n            }\r\n            } else {\r\n                response.writeHead(200, {'Content-Type' : 'text/html'});\r\n                response.write('<html><head><title>Error loading image!</title></head><body><center><h1>Error loading image!</h1><h3>Sorry, the image you requested could not be found. Reload, or try again later.</h3></center></body></html>');\r\n                response.end ();\r\n            }\r\n    });\r\n    \r\n    "],[0,"\r\n\tr"]],"start1":1933,"start2":1933,"length1":37,"length2":933}]],"length":4300,"saved":false}
{"ts":1360871433848,"patch":[[{"diffs":[[0,"et('/img"],[1,"/:url"],[0,"', funct"]],"start1":1870,"start2":1870,"length1":16,"length2":21},{"diffs":[[0,"le.log(\""],[-1,"logging out\");\r\n\t"],[1,"image\");\r\n\t\r\n    urlToFetch = req.param[\"url\"];\r\n    "],[0,"\r\n    cr"]],"start1":1915,"start2":1915,"length1":33,"length2":69}]],"length":4341,"saved":false}
{"ts":1360871562237,"patch":[[{"diffs":[[0,"    "],[-1,"createImage (request, response, function (data, request, response) {"],[1,"var theURL = request.session.url ? request.session.url : \"http://www.google.com\";\r\n    new Image({ url: theURL }).convert (function (err, data) {\r\n        if (err) {\r\n            console.log(err);\r\n        }"],[0,"\r\n  "]],"start1":1978,"start2":1978,"length1":76,"length2":215},{"diffs":[[0,"if ("],[-1,"request.session && request.session."],[0,"call"]],"start1":2274,"start2":2274,"length1":43,"length2":8},{"diffs":[[0,"    "],[-1,"  request.session."],[0,"callback"],[1," "],[0,"(data,"],[-1," request.session.oauth,"],[0," req"]],"start1":2301,"start2":2301,"length1":63,"length2":23},{"diffs":[[0,"      } else {\r\n"],[-1,"  "],[0,"              re"]],"start1":2349,"start2":2349,"length1":34,"length2":32},{"diffs":[[0,"\r\n              "],[-1," "],[-1," "],[0,"response.write(d"]],"start1":2467,"start2":2467,"length1":34,"length2":32},{"diffs":[[0,"ite(data);\r\n"],[-1,"  "],[0,"            "]],"start1":2494,"start2":2494,"length1":26,"length2":24},{"diffs":[[0,"     }\r\n        "],[-1,"    "],[0,"} else {\r\n      "]],"start1":2545,"start2":2545,"length1":36,"length2":32},{"diffs":[[0,"    "],[-1,"    response.writeHead(200, {'Content-Type' : 'text/html'});\r\n                response.write('<html><head><title>Error loading image!</title></head><body><center><h1>Error loading image!</h1><h3>Sorry, the image you requested could not be found. Reload, or try again later.</h3></center></body></"],[1,"fs.createReadStream('./image_error."],[0,"html"],[-1,">"],[0,"')"],[-1,";\r\n                response.end ();\r\n    "],[1,".pipe(response);\r\n"],[0,"    "]],"start1":2579,"start2":2579,"length1":352,"length2":67}]],"length":4110,"saved":false}
{"ts":1360871605216,"patch":[[{"diffs":[[0,"\n\t\r\n    "],[1,"var "],[0,"urlToFet"]],"start1":1932,"start2":1932,"length1":16,"length2":20},{"diffs":[[0,"m[\"url\"]"],[1," ? req.param[\"url\"] : \"http://www.google.com\""],[0,";\r\n    \r"]],"start1":1965,"start2":1965,"length1":16,"length2":61}]],"length":4159,"saved":false}
{"ts":1360871617934,"patch":[[{"diffs":[[0,"  \r\n"],[-1,"    var theURL = request.session.url ? request.session.url : \"http://www.google.com\";\r\n"],[0,"    "]],"start1":2023,"start2":2023,"length1":95,"length2":8},{"diffs":[[0,"rl: "],[-1,"theURL"],[1,"urlToFetch"],[0," })."]],"start1":2044,"start2":2044,"length1":14,"length2":18}]],"length":4076,"saved":false}
{"ts":1360871759974,"patch":[[{"diffs":[[0," {\r\n"],[-1,"            //see if we have a callback function\r\n            if (callback) {\r\n              callback (data, request, response); \r\n            } else {\r\n  "],[0,"    "]],"start1":2174,"start2":2174,"length1":163,"length2":8},{"diffs":[[0,"; \r\n            "],[-1,"  "],[0,"response.write(d"]],"start1":2276,"start2":2276,"length1":34,"length2":32},{"diffs":[[0,"ite(data);\r\n"],[-1,"  "],[0,"            "]],"start1":2303,"start2":2303,"length1":26,"length2":24},{"diffs":[[0,");\r\n            "],[-1,"}"],[0,"\r\n        } else"]],"start1":2341,"start2":2341,"length1":33,"length2":32},{"diffs":[[0,"    "],[-1,"fs.createReadStream('./image_error.html').pipe("],[1,"response.writeHead(200, {'Content-Type' : 'text/html' }); \r\n            response.write(\"error:\"+err);\r\n            "],[0,"response"],[1,".end ("],[0,");\r\n"]],"start1":2385,"start2":2385,"length1":63,"length2":137}]],"length":3990,"saved":false}
{"ts":1360871788712,"patch":[[{"diffs":[[0,"\n            res"],[-1,"ponse"],[0,".writeHead(200, "]],"start1":2177,"start2":2177,"length1":37,"length2":32},{"diffs":[[0,"         res"],[-1,"ponse"],[0,".write(data)"]],"start1":2278,"start2":2278,"length1":29,"length2":24},{"diffs":[[0,"\n            res"],[-1,"ponse"],[0,".end ();\r\n      "]],"start1":2304,"start2":2304,"length1":37,"length2":32},{"diffs":[[0,"         res"],[-1,"ponse"],[0,".writeHead(2"]],"start1":2365,"start2":2365,"length1":29,"length2":24},{"diffs":[[0,"     res"],[-1,"ponse"],[0,".write(\""]],"start1":2436,"start2":2436,"length1":21,"length2":16},{"diffs":[[0," res"],[-1,"ponse"],[0,".end"]],"start1":2478,"start2":2478,"length1":13,"length2":8}]],"length":3960,"saved":false}
{"ts":1360871805276,"patch":[[{"diffs":[[0,") {\r\n\t\t\t"],[1,"var "],[0,"user = u"]],"start1":1261,"start2":1261,"length1":16,"length2":20}]],"length":3964,"saved":false}
{"ts":1360871990628,"patch":[[{"diffs":[[0,"port),\r\n"],[1,"    image = require('./image');\r\n"],[0,"    dirt"]],"start1":70,"start2":70,"length1":16,"length2":49}]],"length":3997,"saved":false}
{"ts":1360873863427,"patch":[[{"diffs":[[0,"\r\n};\r\n\r\n"],[1,"//"],[0,"var user"]],"start1":199,"start2":199,"length1":16,"length2":18}]],"length":3999,"saved":false}
{"ts":1360873869389,"patch":[[{"diffs":[[0,"/image')"],[-1,";"],[1,","],[0,"\r\n    di"]],"start1":100,"start2":100,"length1":17,"length2":17}]],"length":3999,"saved":false}
{"ts":1360873972996,"patch":[[{"diffs":[[0,"als,"],[-1,"sections:sectionsDb,app:appDb.get('app'),page:appDb.get('page'),"],[0,"err:"]],"start1":816,"start2":816,"length1":72,"length2":8}]],"length":3935,"saved":false}
{"ts":1360874185033,"patch":[[{"diffs":[[0,"uire('./"],[1,"lib/"],[0,"image'),"]],"start1":93,"start2":93,"length1":16,"length2":20}]],"length":3939,"saved":false}
{"ts":1360874422180,"patch":[[{"diffs":[[0," page\");\r\n\r\n    "],[1,"//"],[0,"locals.date = ne"]],"start1":436,"start2":436,"length1":32,"length2":34},{"diffs":[[0,"x.ejs', "],[-1,"{"],[0,"locals"],[-1,":locals}"],[0,");\r\n});\r"]],"start1":522,"start2":522,"length1":31,"length2":22}]],"length":3932,"saved":false}
{"ts":1360874460706,"patch":[[{"diffs":[[0,"img/:url"],[1,"?"],[0,"', funct"]],"start1":1847,"start2":1847,"length1":16,"length2":17}]],"length":3933,"saved":false}
